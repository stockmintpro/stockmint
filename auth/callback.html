<!DOCTYPE html>
<html>
<head>
    <title>StockMint - Google Authentication</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: #19BEBB;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .loading {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #19BEBB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px 0;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }
        
        .status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .btn {
            padding: 12px 24px;
            background: #19BEBB;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-top: 20px;
        }
        
        .btn:hover {
            background: #0fa8a6;
        }
        
        .details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
            font-size: 12px;
            color: #666;
        }
        
        .details pre {
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üìä</div>
        <h1>StockMint Authentication</h1>
        <p>Processing Google login...</p>
        
        <div class="loading"></div>
        
        <div id="statusMessage" class="status" style="display: none;"></div>
        
        <div id="userInfo" style="display: none; margin: 20px 0;">
            <h3 style="color: #19BEBB; margin-bottom: 10px;">Welcome!</h3>
            <p id="userName"></p>
            <p id="userEmail" style="font-size: 14px; color: #666;"></p>
        </div>
        
        <div id="errorSection" style="display: none;">
            <a href="../index.html" class="btn">‚Üê Back to Login</a>
        </div>
        
        <div class="details" style="display: none;">
            <h4>Debug Information:</h4>
            <pre id="debugInfo"></pre>
        </div>
    </div>

    <script>
        // 1. Parse URL hash for OAuth response
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        
        // Debug info
        const debugInfo = {
            hash: hash,
            accessToken: params.get('access_token'),
            tokenType: params.get('token_type'),
            expiresIn: params.get('expires_in'),
            state: params.get('state'),
            error: params.get('error'),
            errorDescription: params.get('error_description'),
            timestamp: new Date().toISOString(),
            origin: window.location.origin,
            pathname: window.location.pathname
        };
        
        // Show debug info (optional)
        document.getElementById('debugInfo').textContent = JSON.stringify(debugInfo, null, 2);
        document.querySelector('.details').style.display = 'block';
        
        console.log('üîç OAuth Callback Debug:', debugInfo);
        
        // 2. Check for errors
        if (debugInfo.error) {
            showError(`Google Authentication Error: ${debugInfo.error}`, 
                     debugInfo.errorDescription || 'Please try again.');
            return;
        }
        
        // 3. Check for access token
        if (!debugInfo.accessToken) {
            showError('No Access Token', 
                     'Authentication token not found. Please try logging in again.');
            return;
        }
        
        // 4. Validate state (CSRF protection)
        const savedState = localStorage.getItem('stockmint_oauth_state');
        if (debugInfo.state && savedState && debugInfo.state !== savedState) {
            showError('Security Error', 
                     'Invalid authentication state. Possible CSRF attack.');
            return;
        }
        
        // Clear state
        if (debugInfo.state) {
            localStorage.removeItem('stockmint_oauth_state');
        }
        
        // 5. Save token and fetch user info
        localStorage.setItem('stockmint_token', debugInfo.accessToken);
        showStatus('Fetching user information...', 'warning');
        
        fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
            headers: { 'Authorization': `Bearer ${debugInfo.accessToken}` }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(user => {
            // 6. Save user data
            const userData = {
                name: user.name,
                email: user.email,
                picture: user.picture,
                googleId: user.id,
                isDemo: false,
                loginTime: new Date().toISOString()
            };
            
            localStorage.setItem('stockmint_user', JSON.stringify(userData));
            localStorage.setItem('stockmint_plan', 'basic');
            
            // 7. Show success
            showStatus('Login successful!', 'success');
            
            // Show user info
            document.getElementById('userName').textContent = `Hello, ${user.name}!`;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userInfo').style.display = 'block';
            
            // 8. Cari spreadsheet yang sudah ada untuk user ini
            setTimeout(() => {
                findExistingSpreadsheet(debugInfo.accessToken, user.email);
            }, 1000);
            
        })
        .catch(error => {
            console.error('‚ùå Error fetching user info:', error);
            showError('Failed to get user information', error.message);
        });
        
        // ===== HELPER FUNCTIONS =====
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }
        
        function showError(title, message) {
            showStatus(`${title}: ${message}`, 'error');
            document.getElementById('errorSection').style.display = 'block';
            document.querySelector('.loading').style.display = 'none';
        }
        
        // PERBAIKAN: Fungsi untuk redirect dengan path yang benar
        function redirectToApp() {
            // Tentukan base path berdasarkan lokasi file
            let basePath = '/';
            
            // Jika kita berada di GitHub Pages dengan repository name "stockmint"
            if (window.location.pathname.includes('/stockmint/')) {
                basePath = '/stockmint/';
            }
            
            setTimeout(() => {
                showStatus('Redirecting to StockMint...', 'success');
                setTimeout(() => {
                    window.location.href = basePath + 'app.html';
                }, 1500);
            }, 2000);
        }
        
        // PERBAIKAN: Fungsi findExistingSpreadsheet
        async function findExistingSpreadsheet(token, userEmail) {
            try {
                showStatus('Looking for existing data...', 'warning');
                
                // Search for existing spreadsheets dengan nama yang mengandung "StockMint"
                // PERBAIKAN: Hapus filter by owner karena terkadang tidak akurat
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=` +
                    `name contains 'StockMint' and ` +
                    `mimeType='application/vnd.google-apps.spreadsheet' and ` +
                    `trashed = false&` +
                    `fields=files(id,name,webViewLink,createdTime)&orderBy=createdTime desc`,
                    {
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json'
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.files && data.files.length > 0) {
                        // Gunakan spreadsheet yang paling baru
                        const existingSheet = data.files[0];
                        localStorage.setItem('stockmint_google_sheet_id', existingSheet.id);
                        localStorage.setItem('stockmint_google_sheet_url', 
                            existingSheet.webViewLink || `https://docs.google.com/spreadsheets/d/${existingSheet.id}/edit`);
                        localStorage.setItem('stockmint_spreadsheet_name', existingSheet.name);
                        localStorage.setItem('stockmint_spreadsheet_found', 'true');
                        
                        showStatus(`Found existing spreadsheet: ${existingSheet.name}`, 'success');
                        
                        // PERBAIKAN: Juga simpan tanggal setup jika tersedia
                        if (existingSheet.createdTime) {
                            localStorage.setItem('stockmint_setup_date', existingSheet.createdTime);
                        }
                    } else {
                        // No existing spreadsheet
                        localStorage.setItem('stockmint_spreadsheet_found', 'false');
                        showStatus('No existing data found. Setup required.', 'warning');
                    }
                }
                
                // Redirect ke app
                redirectToApp();
                
            } catch (error) {
                console.error('Error searching for spreadsheets:', error);
                localStorage.setItem('stockmint_spreadsheet_found', 'error');
                
                // Still redirect to app (will use local storage)
                redirectToApp();
            }
        }
        
        // Auto-redirect if no hash after 5 seconds (fallback)
        setTimeout(() => {
            if (!hash && !debugInfo.error) {
                // Gunakan redirectToApp untuk konsistensi
                redirectToApp();
            }
        }, 5000);
    </script>
</body>
</html>
